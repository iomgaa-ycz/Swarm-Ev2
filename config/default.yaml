# Swarm-Ev2 主配置文件
# 使用 OmegaConf 加载，支持环境变量插值和 CLI 参数覆盖

# ============================================================
# 项目基础配置
# ============================================================
project:
  name: "Swarm-Ev2"
  version: "0.1.0"
  workspace_dir: "./workspace"  # 工作空间根目录
  log_dir: "./logs"  # 日志目录
  exp_name: null  # 实验名称，null 时自动生成（格式: YYYYMMDD_HHMMSS_xxxx）

# ============================================================
# 数据配置
# ============================================================
data:
  data_dir: "./datasets/public"  # 数据目录路径（默认 datasets/public）
  desc_file: null  # 数据描述文件路径（自动从 data_dir 读取 description.md）
  goal: null  # 任务目标描述（可选，与 desc_file 二选一）
  eval: null  # 评估指标（可选）
  preprocess_data: true  # 是否预处理数据
  copy_data: false  # false: 使用 symlink（只读），true: 复制数据

# ============================================================
# LLM 后端配置
# ============================================================
llm:
  # Code 生成 Agent 使用的 LLM
  code:
    provider: ${env:LLM_PROVIDER, "openai"}  # 必填：openai | anthropic
    model: ${env:LLM_MODEL, "gpt-4-turbo"}
    temperature: 0.5
    api_key: ${env:OPENAI_API_KEY}  # 从环境变量读取
    base_url: ${env:OPENAI_BASE_URL, "https://api.openai.com/v1"}  # API 端点
    max_tokens: ${env:MAX_TOKENS, null}  # 最大生成 token 数

  # Feedback Agent 使用的 LLM（Review 评估）
  feedback:
    provider: ${env:LLM_PROVIDER, "openai"}
    model: ${env:LLM_MODEL, "glm-4.6"}  # 默认使用 GLM-4.6（支持 Function Calling）
    temperature: 0.5
    api_key: ${env:OPENAI_API_KEY}
    base_url: ${env:OPENAI_BASE_URL, "https://open.bigmodel.cn/api/coding/paas/v4"}
    max_tokens: ${env:MAX_TOKENS, null}

# ============================================================
# 执行配置
# ============================================================
execution:
  timeout: 3600  # 基础超时时间（秒）
  timeout_max: 7200  # 最大超时时间（秒，自适应模式下的上限）
  adaptive_timeout: true  # 是否启用自适应超时（根据数据集大小动态调整）
  agent_file_name: "runfile.py"  # Agent 执行文件名
  format_tb_ipython: false  # 是否使用 IPython 格式化 traceback

# ============================================================
# Agent 配置
# ============================================================
agent:
  max_steps: 150  # 最大迭代步数（测试用，生产环境建议 50+）
  time_limit: 43200  # 总时间限制（秒，12 小时）
  k_fold_validation: 5  # K-fold 交叉验证折数
  expose_prediction: false  # 是否暴露预测结果给 Agent
  data_preview: true  # 是否提供数据预览
  convert_system_to_user: false  # 是否将 system message 转换为 user message

# ============================================================
# 搜索算法配置（Phase 3 使用）
# ============================================================
search:
  strategy: "mcts"  # 搜索策略: mcts | genetic
  max_debug_depth: 3  # 最大调试深度
  debug_prob: 0.5  # 调试概率
  num_drafts: 5  # 初始草稿数量
  parallel_num: 2  # 并行执行数量

# ============================================================
# 环境配置（设备信息 & Conda 环境）
# ============================================================
environment:
  conda_env_name: "Swarm-Evo"  # Conda 环境名称

# ============================================================
# 日志配置
# ============================================================
logging:
  level: "INFO"  # 日志级别: DEBUG | INFO | WARNING | ERROR
  console_output: true  # 是否输出到控制台
  file_output: true  # 是否输出到文件（logs/system.log 和 logs/metrics.json）

# ============================================================
# 进化算法配置（Phase 3）
# ============================================================
evolution:
  # 经验池配置
  experience_pool:
    max_records: 10000  # 最大记录数
    top_k: 5  # Top-K 查询默认值
    save_path: "workspace/evolution/experience_pool.json"  # JSON 持久化路径

  # Solution 层遗传算法配置（P3.4 使用）
  solution:
    population_size: 12  # 种群大小（GA 操作时实际使用的上限）
    ga_trigger_threshold: 4  # GA 触发最小 good_nodes 数（解耦于 population_size）
    elite_size: 3  # 精英保留数量
    crossover_rate: 0.8  # 交叉概率
    mutation_rate: 0.2  # 变异概率
    tournament_k: 3  # 锦标赛选择 k 值
    steps_per_epoch: 10  # 每个 Epoch 的进化步数
    crossover_strategy: "random"  # 交叉策略: "random" 或 "pheromone"
    phase1_target_nodes: 8       # Phase 1 目标：valid_pool 达此数量
    debug_max_attempts: 2        # debug_chain 最大次数

  # Agent 层进化配置（P3.3 使用）
  agent:
    num_agents: 4  # Agent 数量
    evolution_interval: 3  # 每 N 个 Epoch 进化一次
    epsilon: 0.3  # Epsilon-Greedy 探索率
    learning_rate: 0.3  # EMA 更新学习率（α）
    configs_dir: "benchmark/mle-bench/agent_configs"  # Agent 配置文件根目录
    min_records_for_evolution: 20  # 进化前最小经验池记录数

  # Skill 池配置（P3.5 使用）
  skill:
    min_cluster_size: 5  # HDBSCAN 最小簇大小
    duplicate_threshold: 0.85  # 语义相似度阈值（去重）
    min_composite_score: 0.5  # 新增 Skill 的最低综合评分
    deprecate_threshold: 0.4  # 淘汰 Skill 的综合评分阈值
    unused_epochs: 5  # 连续未使用 Epoch 数（淘汰条件）
    embedding_model_path: "./embedding-models/bge-m3"  # bge-m3 本地路径
