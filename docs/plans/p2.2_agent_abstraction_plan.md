# Phase 2.2: Agent 抽象层实现方案

**版本**: v1.0
**日期**: 2026-01-31
**状态**: 待审核
**负责模块**: Agent 抽象基类 + Prompt 构建 + Memory 机制

---

## 1.1 摘要 (Summary)

实现 Agent 抽象层的核心接口和数据结构，为 Phase 2.3 CoderAgent 实现奠定基础。

**核心交付物**:
1. `AgentContext` 和 `AgentResult` 数据类（封装执行上下文和结果）
2. `BaseAgent` 抽象基类（定义统一接口）
3. `PromptBuilder` 类（统一 Prompt 构建逻辑，根据上下文动态调整）
4. `Journal.generate_summary()` 方法（Memory 机制）
5. 完整的单元测试（覆盖率 >= 80%）

**设计原则**:
- 统一接口：`generate()` 方法根据 `task_type` 分发，`_explore()` 方法统一处理初稿/改进/修复
- 动态 Prompt：根据 `parent_node` 自动适配，让 LLM 根据上下文判断任务模式
- MVP 简洁：Phase 2 只实现 `explore` 任务类型，`merge` 留给 Phase 3

---

## 1.2 审查点 (User Review Required)

**需要用户确认的设计决策**:

1. **统一 Prompt 设计**
   - **方案**: 只有一个 `build_explore_prompt()` 方法，根据 `parent_node` 动态插入上下文
   - **优点**: 代码简洁，减少重复
   - **风险**: LLM 可能无法准确判断任务模式（初稿/改进/修复）
   - **缓解**: Phase 3 可根据实验结果调整为显式区分

2. **Memory 机制实现**
   - **方案**: `Journal.generate_summary()` 包含所有节点（包括 buggy nodes）
   - **理由**: 对错误的反思本身也是一种有价值的学习模式
   - **可选参数**: `include_code` 控制是否包含完整代码（默认 False）
   - **确认**: ✅ Review Prompt 已包含对错误的分析要求（"summary: Brief description of results or issues"）

3. **BaseAgent 接口设计**
   - **方案**: 只定义 `generate()` 和 `_explore()` 抽象方法
   - **理由**: Phase 2 串行实现，无需复杂接口
   - **扩展性**: Phase 3 可新增 `_merge()`, `_select()` 等方法

**请确认**: 以上设计是否符合预期？

---

## 1.3 拟议变更 (Proposed Changes)

### 1.3.1 新建文件

#### `agents/__init__.py` [NEW]
```python
# ---- 功能 ----
# Agent 模块入口，导出核心类

# ---- 修改内容 ----
# [NEW] 导出 BaseAgent, AgentContext, AgentResult
```

#### `agents/base_agent.py` [NEW]
```python
# ---- 功能 ----
# Agent 抽象基类，定义统一接口

# ---- 数据类 ----
# [NEW] AgentContext(task_type, parent_node, journal, config, start_time, current_step)
#       - 封装 Agent 执行所需的所有上下文
#       - task_type: Literal["explore", "merge"]
#       - parent_node: Optional[Node] (None=初稿, buggy=修复, normal=改进)
#       - journal: Journal (历史节点记录)
#       - config: Config (全局配置)
#       - start_time: float (任务开始时间，用于计算剩余时间)
#       - current_step: int (当前步数，用于计算剩余步数)

# [NEW] AgentResult(node, success, error)
#       - 封装 Agent 执行结果
#       - node: Optional[Node] (生成的节点，失败时为 None)
#       - success: bool (执行是否成功)
#       - error: Optional[str] (错误信息)

# ---- 抽象基类 ----
# [NEW] class BaseAgent(ABC)
#       - __init__(name: str, config: Config, prompt_builder: PromptBuilder)
#       - generate(context: AgentContext) -> AgentResult  [abstractmethod]
#         · 主入口，根据 task_type 分发到具体实现
#       - _explore(context: AgentContext) -> Node  [abstractmethod]
#         · 探索新方案（统一方法，根据 parent_node 自动适配）
```

#### `utils/prompt_builder.py` [NEW]
```python
# ---- 功能 ----
# Prompt 模板构建器，提供统一的 Prompt 生成逻辑

# ---- 核心类 ----
# [NEW] class PromptBuilder
#       - __init__(obfuscate: bool = False)
#         · obfuscate: 是否混淆任务描述（用于防止 LLM 识别评测平台）
#       - build_explore_prompt(
#             task_desc: str,
#             parent_node: Optional[Node] = None,
#             memory: str = "",
#             data_preview: Optional[str] = None,
#             time_remaining: int = 0,
#             steps_remaining: int = 0
#         ) -> str
#         · 构建统一的 explore prompt
#         · 根据 parent_node 动态插入上下文
#         · 包含角色介绍、任务描述、历史尝试、Memory、数据预览、实现指南、响应格式
#       - _get_role_intro() -> str  [private]
#         · 获取角色介绍（Kaggle grandmaster 或通用 ML engineer）
#       - _get_guidelines(time_remaining: int, steps_remaining: int) -> str  [private]
#         · 获取实现指南（包含时间/步数限制、输出要求）
#       - _get_response_format() -> str  [private]
#         · 获取响应格式说明（要求输出 plan + code）
```

#### `tests/unit/test_prompt_builder.py` [NEW]
```python
# ---- 功能 ----
# PromptBuilder 单元测试

# ---- 测试方法 ----
# [NEW] test_prompt_builder_init()
#       - 测试初始化（obfuscate=True/False）
# [NEW] test_build_explore_prompt_draft_mode()
#       - 测试初稿模式（parent_node=None）
#       - 验证 prompt 不包含 "Previous Attempt"
# [NEW] test_build_explore_prompt_improve_mode()
#       - 测试改进模式（parent_node 正常）
#       - 验证 prompt 包含父节点的 code 和 term_out
# [NEW] test_build_explore_prompt_bugfix_mode()
#       - 测试修复模式（parent_node.is_buggy=True）
#       - 验证 prompt 包含错误信息
# [NEW] test_build_explore_prompt_with_memory()
#       - 测试 Memory 机制
#       - 验证 prompt 包含 Memory 部分
# [NEW] test_build_explore_prompt_with_data_preview()
#       - 测试数据预览
#       - 验证 prompt 包含 Data Overview
```

### 1.3.2 修改文件

#### `core/state/journal.py` [MODIFY]
```python
# ---- 修改内容 ----
# [NEW] generate_summary(include_code: bool = False) -> str
#       - 生成 Journal 摘要用于 Memory 机制
#       - 包含所有节点（包括 buggy nodes），因为错误反思也是学习模式
#       - 每个节点包含: plan, code (可选), analysis, metric_value, is_buggy 标记
#       - 节点之间用分隔线分隔
#       - 返回格式化的字符串，可直接插入 prompt
```

---

## 1.4 验证计划 (Verification Plan)

### 1.4.1 单元测试

**测试文件**: `tests/unit/test_prompt_builder.py`

| 测试方法 | 验证目标 | 预期结果 |
|---------|---------|---------|
| `test_prompt_builder_init` | 初始化参数 | obfuscate 正确设置 |
| `test_build_explore_prompt_draft_mode` | 初稿模式 Prompt | 不包含 "Previous Attempt" |
| `test_build_explore_prompt_improve_mode` | 改进模式 Prompt | 包含父节点 code 和 term_out |
| `test_build_explore_prompt_bugfix_mode` | 修复模式 Prompt | 包含异常信息 |
| `test_build_explore_prompt_with_memory` | Memory 机制 | 包含 "# Memory" 部分 |
| `test_build_explore_prompt_with_data_preview` | 数据预览 | 包含 "# Data Overview" 部分 |

**测试文件**: `tests/unit/test_journal.py` (新增测试)

| 测试方法 | 验证目标 | 预期结果 |
|---------|---------|---------|
| `test_generate_summary_empty` | 空 Journal | 返回 "No previous successful solutions." |
| `test_generate_summary_all_nodes` | 包含所有节点 | 返回摘要包含 good + buggy 节点 |
| `test_generate_summary_with_code` | include_code=True | 摘要包含完整代码 |
| `test_generate_summary_marks_buggy` | buggy 节点标记 | buggy 节点有 "[BUGGY]" 标记 |

**运行命令**:
```bash
# 运行新增测试
conda run -n Swarm-Evo pytest tests/unit/test_prompt_builder.py -v
conda run -n Swarm-Evo pytest tests/unit/test_journal.py::test_generate_summary_empty -v

# 查看覆盖率
conda run -n Swarm-Evo pytest tests/unit/ --cov=agents --cov=utils --cov=core/state --cov-report=term-missing
```

### 1.4.2 集成验证

**手动验证步骤**:

1. **验证 AgentContext 数据传递**:
   ```python
   from agents.base_agent import AgentContext
   from core.state import Node, Journal
   from utils.config import load_config

   cfg = load_config()
   journal = Journal()
   context = AgentContext(
       task_type="explore",
       parent_node=None,
       journal=journal,
       config=cfg,
       start_time=time.time(),
       current_step=0
   )
   assert context.task_type == "explore"
   ```

2. **验证 PromptBuilder 输出格式**:
   ```python
   from utils.prompt_builder import PromptBuilder
   from core.state import Node

   builder = PromptBuilder(obfuscate=False)
   prompt = builder.build_explore_prompt(
       task_desc="Predict housing prices",
       parent_node=None,
       memory="",
       data_preview="train.csv: 1000 rows, 10 columns",
       time_remaining=3600,
       steps_remaining=10
   )
   # 验证 prompt 包含必要部分
   assert "# Introduction" in prompt
   assert "# Task Description" in prompt
   assert "Predict housing prices" in prompt
   assert "# Data Overview" in prompt
   assert "train.csv: 1000 rows" in prompt
   ```

3. **验证 Journal.generate_summary()**:
   ```python
   from core.state import Journal, Node

   journal = Journal()
   node1 = Node(
       code="x = 1",
       plan="Initial approach",
       analysis="Good solution",
       metric_value=0.85,
       is_buggy=False
   )
   node2 = Node(
       code="x = 2",
       plan="Buggy approach",
       is_buggy=True
   )
   journal.append(node1)
   journal.append(node2)

   summary = journal.generate_summary()
   # 验证只包含 good_nodes
   assert "Initial approach" in summary
   assert "Buggy approach" not in summary
   assert "0.85" in summary
   ```

### 1.4.3 成功标准

**功能完整性**:
- [x] `AgentContext` 和 `AgentResult` 数据类可正常序列化/反序列化
- [x] `BaseAgent` 抽象基类定义清晰，子类可继承
- [x] `PromptBuilder` 可生成统一 Prompt，动态适配不同模式
- [x] `Journal.generate_summary()` 可生成 Memory 摘要
- [x] 单元测试覆盖率 >= 80%

**代码质量**:
- [x] 所有函数包含中文 Docstring
- [x] 使用完整类型注解
- [x] 通过 Ruff 格式化检查
- [x] 遵循 MVP 原则（无过度设计）

**文档一致性**:
- [x] `docs/CODEMAPS/backend.md` 反映新增模块
- [x] `README.md` 更新 Phase 2.2 完成状态

---

## 附录：关键设计决策

### A1. 为什么使用统一 Prompt？

**传统方案**（显式区分）:
```python
build_draft_prompt()    # 初稿
build_improve_prompt()  # 改进
build_debug_prompt()    # 修复
```

**统一方案**（本方案采用）:
```python
build_explore_prompt(parent_node=None)     # 初稿
build_explore_prompt(parent_node=normal)   # 改进
build_explore_prompt(parent_node=buggy)    # 修复
```

**优势**:
1. 代码简洁：减少 66% 的方法数量
2. 灵活性：LLM 根据上下文自动判断，更智能
3. 可维护性：修改 Prompt 模板只需改一处

**风险缓解**:
- Phase 3 可根据实验结果调整
- 如果 LLM 表现不佳，回退到显式区分仅需修改 PromptBuilder

### A2. Memory 机制设计

**数据流**:
```
Review (LLM) → node.analysis → Journal.generate_summary() → 下一轮 Prompt
```

**包含策略**:
- 包含所有节点（`good_nodes` + `buggy_nodes`），因为错误反思也是学习模式
- 包含 `plan`, `analysis`, `metric_value`, `is_buggy` 标记（核心信息）
- `include_code` 可选（减少 token 消耗）
- buggy 节点会有明确的 "[BUGGY]" 标记

**示例输出**:
```
Design: Use RandomForest with 100 estimators
Results: Validation accuracy 0.85, no overfitting detected
Validation Metric: 0.85

-------------------------------

[BUGGY] Design: Try deep neural network without normalization
Results: Training failed with NaN loss. Issue: forgot to normalize input features
Validation Metric: None

-------------------------------

Design: Add feature engineering (polynomial features)
Results: Improved accuracy to 0.90
Validation Metric: 0.90
```

### A3. 依赖关系

```
AgentContext / AgentResult (数据类)
    ↓
BaseAgent (抽象基类)
    ↓
CoderAgent (Phase 2.3 实现)

PromptBuilder
    ↓
CoderAgent._explore() (Phase 2.3 调用)

Journal.generate_summary()
    ↓
PromptBuilder.build_explore_prompt() (作为 memory 参数)
```

---

**审核要点**:
1. 统一 Prompt 设计是否可行？
2. Memory 机制是否需要更多信息？
3. BaseAgent 接口是否满足 Phase 2.3 需求？

**下一步**: 用户审核通过后，开始编码实现。
