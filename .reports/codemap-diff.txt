# Codemap 差异报告

**生成时间**: 2026-02-01 23:30
**当前版本**: 0.3.0 (Phase 3.5 Skill 进化)
**上一版本**: 0.2.0 (Phase 3.4 Solution层遗传算法)

## 变更统计

| 指标 | 变更前 | 变更后 | 差异 |
|------|--------|--------|------|
| 核心模块数 | 44 | 47 | +3 (+6.8%) |
| 核心代码行数 | ~8313 | ~9100 | +787 (+9.5%) |
| 测试文件数 | 33 | 36 | +3 (+9.1%) |
| 测试代码行数 | ~7166 | ~7936 | +770 (+10.7%) |

**差异百分比**: 9.5% (< 30%，无需用户审批)

## 新增文件

### Phase 3.5 Skill 进化模块

| 文件 | 行数 | 说明 |
|------|------|------|
| `core/evolution/code_embedding_manager.py` | 127 | bge-m3 文本向量化 + 懒加载 + 缓存 |
| `core/evolution/skill_extractor.py` | 302 | HDBSCAN 聚类 + LLM 总结策略模式 |
| `core/evolution/skill_manager.py` | 371 | Skill 质量评估、演化、元数据管理 |

### 测试文件

| 文件 | 说明 |
|------|------|
| `tests/test_evolution/test_code_embedding_manager.py` | 嵌入管理器单元测试 |
| `tests/test_evolution/test_skill_extractor.py` | Skill 提取器单元测试 |
| `tests/test_evolution/test_skill_manager.py` | Skill 管理器单元测试 |

## 修改文件

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `core/evolution/__init__.py` | MODIFY | 导出新增的 Skill 模块 |
| `core/evolution/agent_evolution.py` | MODIFY | 新增 Skill 池更新逻辑 (+47 行) |
| `config/default.yaml` | MODIFY | 新增 evolution.skill 配置节 |
| `docs/plans/phase3_5_skill_evolution_plan.md` | NEW | Phase 3.5 实施方案 |

## 配置新增

```yaml
evolution:
  skill:
    min_cluster_size: 5          # HDBSCAN 最小簇大小
    duplicate_threshold: 0.85    # 语义相似度阈值（去重）
    min_composite_score: 0.5     # 新增 Skill 的最低综合评分
    deprecate_threshold: 0.4     # 淘汰 Skill 的综合评分阈值
    unused_epochs: 5             # 连续未使用 Epoch 数（淘汰条件）
    embedding_model_path: "./embedding-models/bge-m3"
```

## 新增依赖

```
hdbscan          # HDBSCAN 聚类库
sentence-transformers  # bge-m3 嵌入模型
```

## 架构变更

### 进化层扩展

```
进化层 (Evolution)
├── P3.1 GeneParser (162行)
├── P3.2 ExperiencePool (319行)
├── P3.2 Fitness (81行)
├── P3.3 TaskDispatcher (157行)
├── P3.3 AgentEvolution (439行) ← 扩展
├── P3.4 GeneRegistry (199行)
├── P3.4 GeneSelector (314行)
├── P3.4 Pheromone (104行)
├── P3.4 SolutionEvolution (420行)
├── P3.5 CodeEmbeddingManager (127行) ← NEW
├── P3.5 SkillExtractor (302行) ← NEW
└── P3.5 SkillManager (371行) ← NEW
```

## 目录统计

| 目录 | 文件数 | 代码行数 |
|------|--------|---------|
| agents/ | 3 | 400 |
| core/ | 25 | ~4800 |
| utils/ | 10 | ~2029 |
| search/ | 3 | 335 |
| tests/ | 36 | ~7936 |
| **总计** | **77** | **~15500** |

## 审批状态

- [x] 差异 < 30%，自动通过
- [x] 无破坏性变更
- [x] 测试覆盖完整
